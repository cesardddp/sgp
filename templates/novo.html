{% extends 'layout.html' %}
{% block link_rel %}
<link href="{{ url_for('static', filename='css/floatin-label.css') }}" rel="stylesheet">
<link rel="stylesheet" href="{{url_for('static',filename='css/modal.css')}}">
{% endblock link_rel %}
{% block main %}
<main class="container mx-auto px-6 mb-auto">

    <div class="flex justify-center">
        <img src="{{ url_for('static',filename='imgs/pessoa_fundo_verde.png')}}" alt="" class="h-16 w-16" srcset="">
    </div>
    <div class="cloud x2"></div>
    <div id="app"
        class="p-3 text-gray-500 bg-blend-lighten bg-blue-200 border-4 border-light-blue-500 border-opacity-25 rounded-md">


        <form class="flex flex-col justify-items-center space-y-3 " @submit.prevent="novoProjeto">

            <div class="w-full flex">
                <div class="relative z-0 w-5/6 mb-5">
                    <input type="text" name="nome" placeholder=" " v-model="cliente.nome" required
                        class="pt-3 pb-2 block w-full px-0 mt-0 bg-transparent border-0 border-b-2 appearance-none focus:outline-none focus:ring-0 focus:border-black border-gray-200">
                    <label class="absolute duration-300 top-3 -z-1 origin-0 text-gray-500" for="nome">Nome</label>
                </div>
                <div class="w-1/6">
                    <a class="btn btn-square btn-ghost" href="{{ url_for('busca') }}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            class="inline-block w-6 h-6 stroke-current">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </a>
                </div>
            </div>

            <div class="flex justify-center">
                <div class="relative z-0 w-5/6 mb-5">
                    <input type="text" name="endereco" placeholder=" " v-model="cliente.endereco" required
                        class="pt-3 pb-2 block w-full px-0 mt-0 bg-transparent border-0 border-b-2 appearance-none focus:outline-none focus:ring-0 focus:border-black border-gray-200">
                    <label for="endereco"
                        class="absolute duration-300 top-3 -z-1 origin-0 text-gray-500">Endereco</label>
                </div>
                <div class="relative z-0 w-1/6 mb-5">
                    <input type="number" name="numero" v-model="cliente.numero" required
                        class="pt-3 pb-2 block w-full px-0 mt-0 bg-transparent border-0 border-b-2 appearance-none focus:outline-none focus:ring-0 focus:border-black border-gray-200">
                    <label for="numero" class="absolute duration-300 top-3 -z-1 origin-0 text-gray-500">NÂº</label>
                </div>
            </div>

            <div class="flex justify-center">
                <div class="relative z-0 w-full">
                    <input type="tel" name="telefone" placeholder=" " v-model="cliente.telefone" required
                        v-maska="{mask:'(##) # ####-####'}"
                        class="pt-3 pb-2 block w-full px-0 mt-0 bg-transparent border-0 border-b-2 appearance-none focus:outline-none focus:ring-0 focus:border-black border-gray-200">
                    <label class="absolute duration-300 top-3 -z-1 origin-0 text-gray-500"
                        for="telefone">Telefone</label>
                </div>
            </div>


            <div class="flex justify-center">
                <div class="relative z-0 w-4/6">
                    <input type="date" name="data" v-model="data" required
                        class="w-full text-gray-500 pt-3 pb-2 block px-0 mt-0 bg-transparent border-0 border-b-2 appearance-none focus:outline-none focus:ring-0 focus:border-black border-gray-200">
                </div>
                <div class="relative z-0 w-2/6">
                    <input type="time" name="hora" v-model="hora" required
                        class="w-full text-gray-500 pt-3 pb-2 block  px-0 mt-0 bg-transparent border-0 border-b-2 appearance-none focus:outline-none focus:ring-0 focus:border-black border-gray-200">
                </div>
            </div>

            <div v-for="amb in ambientes" class="relative z-0 w-5/6" :key="amb.id">
                <input type="tel" v-model="amb.nome" placeholder=" " required
                    class="pt-3 pb-2 block w-full px-0 mt-0 bg-transparent border-0 border-b-2 appearance-none focus:outline-none focus:ring-0 focus:border-black border-gray-200">
                <label class="absolute duration-300 top-3 -z-1 origin-0 text-gray-500"
                    for="ambiente-1">{{'{{'}}amb.label{{'}}'}}</label>
            </div>
            <button class="self-end bg-blue-500 hover:bg-blue-700 text-white py-2 px-4 rounded-full"
                @click.prevent="add_amb">+ambs</button>
            <button class="self-end bg-red-200 hover:bg-red-500 text-white py-2 px-4 rounded-full"
                @click.prevent="rm_amb">-ambs</button>

            <button class="btn bg-red-200 hover:bg-red-300 py-2 px-4 rounded-b-3xl">
                Novo Projeto</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/maska@latest/dist/maska.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.12.0/dist/axios.min.js"></script>
    <script type="application/javascript">
        default_teste = {
            nome: "name test",
            endereco: "av. 13a",
            telefone: "019 1 0829 9911",
            numero: 1300,
            data: "3/12/2021",
            hora: "11:12"
        }
        const App = {
            data() {
                return {
                    ultimo: 1,
                    ambientes: [{
                        nome: "",
                        id: 1,
                        label: "Ambiente 1"
                    }],
                    cliente: {
                        nome: "",
                        endereco: "",
                        telefone: "",
                        id: ""
                    },
                    data: "",
                    hora: "",
                    isButtonDisabled: true
                }
            },
            methods: {
                add_amb() {
                    this.ultimo = this.ultimo + 1
                    console.log(this.ultimo, this.ambientes)
                    this.ambientes.push({
                        nome: "",
                        id: this.ultimo,
                        label: 'Ambiente ' + this.ultimo
                    })
                },
                rm_amb() {
                    this.ultimo = this.ultimo - 1
                    console.log(this.ultimo, this.ambientes)
                    this.ambientes.pop()
                },
                novoProjeto() {
                    const iso_data = new Date(
                        this.data + ' ' + this.hora
                    ).toISOString();
                    // console.log(iso_data);
                    // console.log(this.ambientes);
                    this.ambientes.forEach(element => {
                        delete (element.id);
                        delete (element.label)
                    })
                    let projeto = {
                        usuario_id: 1,
                        ambientes: this.ambientes,
                        data_entrada: iso_data
                    }
                    if (!this.cliente.id) {
                        let cliente = {
                            endereco: this.cliente.endereco,
                            nome: this.cliente.nome,
                            telefone: this.cliente.telefone
                        }
                        projeto.cliente = cliente
                    } else {
                        projeto.cliente_id = this.cliente.id
                    }

                    axios
                        .post(
                            "{{ url_for('projeto_bp.novo_projeto') }}",
                            projeto
                        )
                        .then(response => {
                            if (response.status === 200) {
                                location.pathname = "{{ url_for('index') }}" + "detalhes/" + response.data
                                    .projeto.id
                            }
                        })
                        .catch(function (error) {
                            console.log(error);
                        });
                }
            },
            mounted() {
                if ("{{cliente|safe}}" != "None") {
                    this.cliente.nome = "{{cliente.nome|safe}}"
                    this.cliente.endereco = "{{cliente.endereco|safe}}"
                    this.cliente.telefone = "{{cliente.telefone|safe}}"
                    this.cliente.id = "{{cliente.id|safe}}"
                }
                this.data = new Date().toISOString().split('T')[0]

                this.hora = new Date().toLocaleTimeString().slice(0, 5)
            },
            watch: {
                isButtonDisabled() {
                    debugger
                    return Boolean(
                        this.ambientes.every() &&
                        this.cliente.nome &&
                        this.cliente.endereco &&
                        this.cliente.telefone
                    )
                }
            },
        }
        var app = Vue.createApp(App)
        app.use(Maska)
        app.mount("#app")
    </script>
</main>

{% endblock main %}